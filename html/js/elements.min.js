function sequenceClickHandler(e){for(var t=e.target;void 0==$(t).attr("sequence_id");)if(t=$(t).parent(),null==t)return!1;for(var a=$(t).attr("sequence_id"),n=$(t).parent().children("a"),i=0;i<n.length;i++){var r=$(n[i]).attr("sequence_id");r!==a&&$(n[i]).children("img").attr("src","img/map.png")}$(t).children("img").attr("src","img/map-path.png"),$("#tripOptions").attr("data-toggle","modal"),$("#tripOptions").attr("data-target","#tripOptionsModal"),$("#tripOptions").unbind("click"),$("#tripOptions").attr("sequence_id",a),$("#tripOptions").click(tripOptionsClickHandler),$("#saveTripSettingsButton").unbind("click"),$("#saveTripSettingsButton").click(saveTripSettings),$("#saveTripSettingsButton").attr("sequence_id",a),displaySequence(a)}function tripOptionsClickHandler(e){var t=$(e.target).attr("sequence_id"),a=$("#sequence_name").html().trim(),n="http://webpersistent.com/motorbike-tracker/index.php?trip="+t;$("#trip_share_url").val(n),$("#trip_options_name").val(a),$("#trip_sharing_check").prop("checked",sequence_share_data[t])}function saveTripSettings(e){var t=$(e.target).attr("sequence_id");ref.child("sequences").child(t).child("name").set($("#trip_options_name").val().trim()),ref.child("sequences").child(t).child("share").set($("#trip_sharing_check").prop("checked"))}function singleInfoWindow(e,t){for(var a in events[e])void 0!=events[e][a].marker&&null!=events[e][a].marker&&events[e][a].infowindow.close();void 0!=events[e][t].marker&&null!=events[e][t].marker&&events[e][t].infowindow.open(map,events[e][t].marker)}function removeRecipient(e){for(var t=$(e.target),a=$(e.target).attr("key");void 0==a&&void 0!=t;)t=t.parent(),a=t.attr("key");t.remove()}function trackerSettingsClickHandler(e){$("#table_settings_notifications").empty();var t=$(e.target).attr("imei");$("#tracker_settings_name").attr("imei",t),$("#tracker_settings_name").val(trackers[t].name),$("#tracker_settings_gps_interval").selectpicker("val",trackers[t].rate);for(var a in trackers[t].notifications){var n={};n[a]=trackers[t].notifications[a];var i=new NotificationRecipient(n);$("#table_settings_notifications").append(i)}}function addTrackerNotificationRecipient(){var e={"some@email,com":{battery:"yes",boot:"yes",location:"no",provision:"yes",sleep:"yes",wake:"yes",temperature:"yes"}},t=new NotificationRecipient(e);$("#table_settings_notifications").append(t)}function saveTrackerSettings(){var e=$("#tracker_settings_name").attr("imei");ref.child("users").child(ref.getAuth().uid).child("imei").child(e).set($("#tracker_settings_name").val().trim()),ref.child("config/imei").child(e).child("rate").set(parseInt($("#tracker_settings_gps_interval").val()));for(var t={},a=$("#table_settings_notifications").children("tr"),n=0;n<a.length;n++){var i=$(a[n]),r=i.find("input[type='email']").val();r=r.trim().toLowerCase().replace(/\./g,","),t[r]={};for(var o=i.find("input[type!='email']"),s=0;s<o.length;s++){var c=$(o[s]),l=c.val();t[r][l]=c.is(":checked")?"yes":"no"}}ref.child("config/imei").child(e).child("notifications").set(t,function(e){e&&$.bootstrapGrowl("There was a problem saving your settings",{type:"danger"})})}function showLastLocation(){null==currentLocationMarker&&(currentLocationMarker=new google.maps.Marker,currentLocationInfowindow=new google.maps.InfoWindow,currentLocationMarker.setZIndex(10),currentLocationInfowindow.setContent("Last known location"),currentLocationMarker.addListener("click",function(){currentLocationInfowindow.open(map,currentLocationMarker)})),currentLocationMarker.setMap(null),currentLocationInfowindow.close();for(var e=Object.keys(events[currentSequence]).sort(),t=e.length-1;t>0;t--){var a=events[currentSequence][e[t]];if(void 0!=a.marker&&null!=a.marker)return currentLocationMarker.setPosition(a.marker.getPosition()),currentLocationMarker.setMap(map),void currentLocationInfowindow.open(map,currentLocationMarker)}}function plot(e,t){if(void 0!=e.location&&null!=e.location){var a=e.location.split(","),n=new google.maps.LatLng(a[0],a[1]);if(null==minLat)minLat=parseFloat(a[0]),maxLat=parseFloat(a[0]),minLng=parseFloat(a[1]),maxLng=parseFloat(a[1]),map.panTo(n);else{var i=parseFloat(a[0]),r=parseFloat(a[1]);minLat=Math.min(minLat,i),maxLat=Math.max(maxLat,i),minLng=Math.min(minLng,r),maxLng=Math.min(maxLng,r);var o=new google.maps.LatLng(minLat,minLng),s=new google.maps.LatLng(maxLat,maxLng),c=new google.maps.LatLngBounds(o,s);map.fitBounds(c),map.panToBounds(c)}var l=Object.keys(events[t]).sort(),d=l.indexOf(e.timestamp),p=!1;if(d>0&&void 0!=events[t][l[d-1]].marker&&null!=events[t][l[d-1]].marker){var m=events[t][l[d-1]];if(m.marker.getPosition().equals(n))events[t][e.timestamp].marker=m.marker,events[t][e.timestamp].infowindow=m.infowindow,p=!0;else{var u=[m.marker.getPosition(),n],g=new google.maps.Polyline({path:u,geodesic:!0,strokeColor:"#8888FF",strokeOpacity:.6,strokeWeight:5});g.setMap(map)}}if(!p){var v=new google.maps.InfoWindow({content:"<div class='list-group'></div>"}),f=new google.maps.Marker({position:n,map:map,zIndex:5,icon:{path:google.maps.SymbolPath.CIRCLE,scale:7,strokeColor:"#FFFFFF",fillColor:"#8888FF",fillOpacity:1,strokeOpacity:.8,strokeWeight:3},title:getDateTimeString(e.timestamp)});f.addListener("click",function(){singleInfoWindow(t,e.timestamp)}),events[t][e.timestamp].marker=f,events[t][e.timestamp].infowindow=v}var h=EventProcessors[e.type],k=$("<div></div>").addClass("list-group-item");$("<img />").attr("src",h.img).addClass("img_icon").appendTo(k),$("<span></span>").html(h.summarize(e)+"&nbsp;&nbsp;").appendTo(k),$("<span></span>").html(getDateTimeString(e.timestamp)).addClass("badge").appendTo(k);var _=$("<div></div>"),w=$(events[t][e.timestamp].infowindow.getContent());w.appendTo(_),w.append(k),events[t][e.timestamp].infowindow.setContent(_.html()),showLastLocation()}}function eventClick(e){for(var t=e.target;void 0==$(t).attr("sequence_id");)if(t=$(t).parent(),null==t)return!1;var a=$(t).attr("sequence_id"),n=$(t).attr("timestamp");void 0!=events[a][n].marker&&null!=events[a][n].marker&&map.setCenter(events[a][n].marker.getPosition()),singleInfoWindow(a,n)}function login(){email=$("#usr_email").val();var e=$("#pwd").val();ref.authWithPassword({email:email,password:e},function(e,t){e?$.bootstrapGrowl("Login failed",{type:"danger"}):completeLogin()})}function validateEmail(e){var t=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return t.test(e)}function sendResetEmail(){var e=$("#reset_email");return validateEmail(e)?void ref.resetPassword({email:e},function(e){$.bootstrapGrowl("Reset e-mail sent",{type:"info"})}):($.bootstrapGrowl("Enter a valid e-mail address",{type:"danger"}),!1)}function createAccount(){var e=$("#new_usr_email").val(),t=$("#newpwd").val(),a=$("#pwdagain").val();return $("#new_usr_email").val(""),$("#newpwd").val(""),$("#pwdagain").val(""),validateEmail(e)?t!==a?($.bootstrapGrowl("Passwords must match",{type:"danger"}),!1):void ref.createUser({email:e,password:t},function(e,t){e?$.bootstrapGrowl("Couldn't create account",{type:"danger"}):($.bootstrapGrowl("Account created",{type:"info"}),completeLogin())}):($.bootstrapGrowl("Enter a valid e-mail address",{type:"danger"}),!1)}function changePassword(){var e=$("#currentpwd").val(),t=$("#setpwd").val(),a=$("#setpwdagain").val();if($("#currentpwd").val(""),$("#setpwd").val(""),$("#setpwdagain").val(""),t!==a)return $.bootstrapGrowl("New passwords must match",{type:"danger"}),!1;var n=ref.getAuth().password.email;ref.changePassword({email:n,oldPassword:e,newPassword:t},function(e){if(e)switch(e.code){case"INVALID_PASSWORD":$.bootstrapGrowl("Incorrect current password",{type:"danger"});break;case"INVALID_USER":$.bootstrapGrowl("Invalid user",{type:"danger"});break;default:$.bootstrapGrowl("Password couldn't be changed",{type:"danger"})}else $.bootstrapGrowl("Password changed",{type:"info"})})}function loadTrackerData(e){var t=$(e.target).attr("imei");ref.child("config/imei/"+t+"/trips").on("value",function(e){null==e.val()&&$(trackers[t].element.imei_sequence_count).html("<i>No trips</i>")}),ref.child("config/imei/"+t).child("notifications").on("value",function(e){trackers[t].notifications=e.val()}),ref.child("config/imei/"+t).child("rate").on("value",function(e){trackers[t].rate=e.val()}),ref.child("config/imei/"+t+"/trips").orderByKey().on("child_added",function(e){var a=e.key(),n=e.val();trackers[t].sequences[a]=n,ref.child("sequences/"+n+"/name").once("value",function(e){var i=e.val(),r=getDateString(a);(void 0==events[n]||null==events[n])&&(events[n]={}),trackers[t].element.addSequence(new Sequence({name:i,date:r,sequence_id:n}))}),ref.child("sequences/"+n+"/name").on("value",function(e){var a=e.val();currentSequence===e.ref().parent().key()&&$("#sequence_name").html(a);var i='a[sequence_id="'+n+'"] span';$(trackers[t].element).find(i).html(a)}),ref.child("sequences").child(n).child("share").on("value",function(e){sequence_share_data[n]=e.val()})}),$(e.target).unbind("click")}function addTracker(e){var t=e.key(),a=e.val(),n=new Tracker({imei:t,name:a});trackers[t]={imei:t,name:a,element:n,sequences:{}},$("#tracker_list").append(n),$.bootstrapGrowl("Found tracker: "+a,{type:"info"})}function getUser(){var e=ref.child("users").child(ref.getAuth().uid);e.once("value",function(e){},function(e){$.bootstrapGrowl("No trackers found",{type:"info"})}),e.child("imei").on("child_changed",function(e){var t=e.key(),a=e.val();$(trackers[t].element.a).html(a),trackers[t].name=a}),e.child("imei").on("child_added",function(e){addTracker(e)}),e.child("imei").on("child_removed",function(e){console.log("user data child_removed - key: "+e.key()),console.log(e.val())})}function completeLogin(){$.bootstrapGrowl("Sign in complete",{type:"info"}),$("#sign_in_text").html(ref.getAuth().password.email),$("#sign_in_button").addClass("hidden"),$("#account_option_button").removeClass("hidden"),$("#create_account_button").addClass("hidden"),$("#reset_password_button").addClass("hidden"),$("#sign_out_button").removeClass("hidden"),$("#claim_tracker_button").removeClass("hidden"),$("#usr_email").val(""),$("#pwd").val(""),getUser()}function logout(){ref.unauth(),$("#sign_in_text").html("Sign in"),$("#sign_in_button").removeClass("hidden"),$("#account_option_button").addClass("hidden"),$("#create_account_button").removeClass("hidden"),$("#reset_password_button").removeClass("hidden"),$("#sign_out_button").addClass("hidden"),$("#tracker_list").empty(),$("#claim_tracker_button").addClass("hidden"),$("#usr_email").val(""),$("#pwd").val("")}function displaySequence(e){null!=currentSequence&&ref.child("sequences/"+currentSequence+"/events").off(),currentSequence=e,$("#event_list").empty(),$("#sequence_panel").collapse("show"),ref.child("sequences/").child(e).child("name").on("value",function(e){$("#sequence_name").html(e.val())}),ref.child("sequences/"+e+"/events").orderByKey().on("child_added",function(t){var a=t.val(),n={timestamp:t.key(),type:a.type};void 0!=a.location&&null!=a.location&&(n.location=a.location),void 0!=a.data&&null!=a.data&&(n.data=a.data),events[e][n.timestamp]={},events[e][n.timestamp].params=n;var i=new Event(n,e);events[e][n.timestamp].element=i,$("#event_list").prepend(i)})}function isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)}function claimTracker(){if($("#new_tracker_imei").val().trim()!==$("#new_tracker_imei_again").val().trim())return void $.bootstrapGrowl("IMEIs don't match!",{type:"danger"});for(var e=$("#new_tracker_imei").val().replace(/-|\s/g,"").trim(),t=0,a=0;a<e.length-1;a++){if(!isNumeric(e.charAt(0)))return void $.bootstrapGrowl("IMEI must be numeric!",{type:"danger"});if(a%2==1)for(var n=2*parseInt(e.charAt(a)+"")+"",i=0;i<n.length;i++)t+=parseInt(n.charAt(i));else t+=parseInt(e.charAt(a))}(t+parseInt(e.charAt(e.length-1)))%10==0?ref.child("config/imei/"+e).child("uid").set(ref.getAuth().uid,function(t){if(t)$.bootstrapGrowl("That IMEI has already been claimed.",{type:"danger "});else{var a={};a[e]=$("#new_tracker_name").val().trim(),ref.child("users/"+ref.getAuth().uid+"/imei").child(e).set($("#new_tracker_name").val().trim(),function(t){if(t)$.bootstrapGrowl("Provisioned the tracker, but unable to lay claim to it. Contact technical support.",{type:"danger"});else{$("#new_tracker_name").val(""),$("#new_tracker_imei").val(""),$("#new_tracker_imei_again").val(""),$.bootstrapGrowl("Provisioned IMEI "+e+" - turn it on now to test it.",{type:"info"});var a=email.replace(/\./g,","),n={battery:"no",boot:"yes",location:"no",provision:"yes",sleep:"yes",wake:"yes",temperature:"no"};ref.child("config/imei/"+e).child("notifications").child(a).set(n,function(e){e&&$.bootstrapGrowl("Unable to set initial notifications for tracker",{type:"success"})}),ref.child("config/imei/"+e).child("rate").set(600,function(e){e&&$.bootstrapGrowl("Unable to set rate for tracker",{type:"success"})})}})}}):$.bootstrapGrowl("IMEI invalid. Check the digits please.",{type:"danger"})}function getDateString(e){var t=new Date(1e3*e);return t.getMonth()+"/"+t.getDate()+"/"+t.getFullYear()}function getTimeString(e){var t=new Date(1e3*e);return t.getHours()+":"+t.getMinutes()}function getDateTimeString(e){return getDateString(e)+" - "+getTimeString(e)}var Event=function(e,t){var a=EventProcessors[e.type],n=$("<a></a>").addClass("list-group-item").attr("href","#").attr("sequence_id",t).attr("timestamp",e.timestamp);return void 0!=a.onClick?n.click(a.onClick):n.click(eventClick),$("<img />").attr("src",a.img).addClass("img_icon").appendTo(n),$("<span></span>").html(a.summarize(e)).appendTo(n),$("<span></span>").html(getDateTimeString(e.timestamp)).addClass("badge").appendTo(n),void 0!=typeof a.process&&null!=a.process?a.process(e,t):plot(e,t),n},Sequence=function(e){var t=$("<a></a>");return t.addClass("list-group-item").attr("href","#").html("<span>"+e.name+"</span> - <i>"+e.date+"</i>").attr("sequence_id",e.sequence_id),t.attr("role","button"),$("<img />").attr("src","img/map.png").addClass("img_icon").appendTo(t),t.click(sequenceClickHandler),t},Tracker=function(e){var t=$('<div class="panel panel-info" id="imei_'+e.imei+'"/>'),a=$('<div class="panel-heading" />'),n=$('<h4 class="panel-title" />'),i=$('<a data-toggle="collapse" href="#imei_info_'+e.imei+'">'+e.name+"</a>");i.appendTo(n),i.attr("imei",e.imei),i.click(loadTrackerData),n.appendTo(a),a.appendTo(t);var r=$('<div id="imei_info_'+e.imei+'" class="panel-collapse collapse" />'),o=$('<div class="panel-body" id="imei_panel_body_'+e.imei+'"></div>').html("<i>Loading</i>");o.appendTo(r);var s=$('<div class="list-group" id="imei_sequence_list_'+e.imei+'" />');s.appendTo(r);var c=$('<div class="panel-footer"><a href="#" imei="'+e.imei+'" data-toggle="modal" data-target="#trackerSettingsModal">Settings</a></div>');return c.children("a").click(trackerSettingsClickHandler),c.appendTo(r),r.appendTo(t),t.imei_sequence_count=o,t.a=i,t.addSequence=function(e){s.prepend(e);var t=s.children().length;0==t?o.html("<i>No trips</i>"):1==t?o.html(t+" trip"):o.html(t+" trips")},t},NotificationRecipient=function(e){var t=Object.keys(e)[0],a=e[t],n=t.replace(/,/g,"."),i=$("<tr key='"+t+"'></tr>");return $("<td></td>").append($("<input type='email' value='"+n+"' />")).appendTo(i),$("<td align=center></td>").append($("<input type='checkbox' value='boot'"+("yes"===a.boot?"checked":"")+" />")).appendTo(i),$("<td align=center></td>").append($("<input type='checkbox' value='sleep'"+("yes"===a.sleep?"checked":"")+" />")).appendTo(i),$("<td align=center></td>").append($("<input type='checkbox' value='wake'"+("yes"===a.wake?"checked":"")+" />")).appendTo(i),$("<td align=center></td>").append($("<input type='checkbox' value='location'"+("yes"===a.location?"checked":"")+" />")).appendTo(i),$("<td align=center></td>").append($("<input type='checkbox' value='temperature'"+("yes"===a.temperature?"checked":"")+" />")).appendTo(i),$("<td align=center></td>").append($("<input type='checkbox' value='battery'"+("yes"===a.battery?"checked":"")+" />")).appendTo(i),$("<td align=center></td>").append($("<input type='checkbox' value='provision'"+("yes"===a.provision?"checked":"")+" />")).appendTo(i),$("<td align=center></td>").append($("<a href='#'><strong>remove</strong></a>").click(removeRecipient)).appendTo(i),i},currentLocationMarker=null,currentLocationInfowindow=null,minLat=null,maxLat=null,minLng=null,maxLng=null,EventProcessors={boot:{img:"img/poweron.png",summarize:function(e){return"Power on"}},gps:{img:"img/gps-fix.png",summarize:function(e){return"Location fix"}},sleep:{img:"img/sleep.png",summarize:function(e){return"Going to sleep"}},wake:{img:"img/wake.png",summarize:function(e){return"Wake! Tracker disturbed!"}},battery:{img:"img/lowbattery.png",summarize:function(e){var t=parseInt(e.data);return"Battery at "+t+"%"}},temp:{img:"img/temperature.png",summarize:function(e){var t=parseInt(e.data);return"Battery at "+t/10+"F"}}},ref=new Firebase("https://motorbike-tracker.firebaseio.com"),currentSequence=null,map,events={},email="",sequence_share_data={},trackers={};
